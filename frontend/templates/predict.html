{% extends "base.html" %}

{% block title %}Predict - Exoplanet Hunter AI{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced card styling for better visibility */
    .card {
        background: rgba(26, 31, 58, 0.95) !important;
        height: 100%;
    }

    /* Light text for headings and titles */
    h1, h2, h3, h4, h5, h6, .card-title {
        color: var(--text-light) !important;
    }

    /* Fixed height for result cards to prevent stretching */
    .result-section {
        min-height: 400px;
    }

    /* Chart container with fixed aspect ratio */
    .chart-container {
        position: relative;
        height: 250px;
        margin-bottom: 1rem;
    }

    .chart-container-large {
        position: relative;
        height: 350px;
        margin-bottom: 1rem;
    }

    /* Improved form styling */
    .form-control:focus {
        box-shadow: 0 0 0 0.25rem rgba(139, 92, 246, 0.25);
    }

    /* Chart containers */
    canvas {
        background: transparent !important;
    }
    
    /* Chart description styling */
    .chart-description {
        color: #9ca3af;
        font-size: 0.875rem;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    /* Stat card styling */
    .stat-card {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        height: 100%;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--nebula-purple);
        margin: 0.5rem 0;
    }

    .stat-label {
        color: #9ca3af;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Loading animation */
    @keyframes spinPulse {
        0% {
            transform: rotate(0deg) scale(1);
        }
        50% {
            transform: rotate(180deg) scale(1.1);
        }
        100% {
            transform: rotate(360deg) scale(1);
        }
    }

    .spinner-border {
        animation: spinPulse 1.5s linear infinite;
    }

    /* Smooth transitions */
    .card, .btn {
        transition: all 0.3s ease;
    }

    /* Result badge styling */
    .result-badge {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 1rem 0;
    }

    .result-badge.confirmed {
        background: rgba(34, 197, 94, 0.2);
        border: 2px solid rgba(34, 197, 94, 0.5);
        color: #86efac;
    }

    .result-badge.candidate {
        background: rgba(251, 191, 36, 0.2);
        border: 2px solid rgba(251, 191, 36, 0.5);
        color: #fcd34d;
    }

    .result-badge.false-positive {
        background: rgba(239, 68, 68, 0.2);
        border: 2px solid rgba(239, 68, 68, 0.5);
        color: #fca5a5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold">
            <i class="bi bi-rocket-takeoff text-star"></i>
            Exoplanet Classification System
        </h1>
        <p class="lead text-muted">
            Advanced AI-powered analysis of stellar observation data
        </p>
    </div>

    <div class="row g-4">
        <!-- Left Column: Input Form -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-sliders"></i> Input Parameters
                    </h5>
                </div>
                <div class="card-body">
                    <form id="predictionForm">
                        <!-- Primary Features -->
                        <h6 class="text-nebula mb-3">
                            <i class="bi bi-star-fill"></i> Primary Features
                        </h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Orbital Period (days)</label>
                            <input type="number" class="form-control" id="koi_period" step="0.01" required>
                            <small class="text-muted">Time to complete one orbit</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Transit Duration (hours)</label>
                            <input type="number" class="form-control" id="koi_duration" step="0.01" required>
                            <small class="text-muted">Duration of planetary transit</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Transit Depth (ppm)</label>
                            <input type="number" class="form-control" id="koi_depth" step="0.01" required>
                            <small class="text-muted">Brightness decrease during transit</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Stellar Radius (solar radii)</label>
                            <input type="number" class="form-control" id="koi_srad" step="0.01" required>
                            <small class="text-muted">Radius of host star</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Stellar Temperature (K)</label>
                            <input type="number" class="form-control" id="koi_steff" step="1" required>
                            <small class="text-muted">Effective temperature</small>
                        </div>

                        <!-- Advanced Features -->
                        <div class="mt-4">
                            <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFeatures">
                                <i class="bi bi-gear"></i> Advanced Features (Optional)
                            </button>
                        </div>

                        <div class="collapse mt-3" id="advancedFeatures">
                            <h6 class="text-nebula mb-3">
                                <i class="bi bi-stars"></i> Additional Parameters
                            </h6>

                            <div class="mb-3">
                                <label class="form-label">Impact Parameter</label>
                                <input type="number" class="form-control" id="koi_impact" step="0.01">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Planet Radius (Earth radii)</label>
                                <input type="number" class="form-control" id="koi_prad" step="0.01">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Stellar Mass (solar masses)</label>
                                <input type="number" class="form-control" id="koi_smass" step="0.01">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Stellar Log(g)</label>
                                <input type="number" class="form-control" id="koi_slogg" step="0.01">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Insolation Flux (Earth flux)</label>
                                <input type="number" class="form-control" id="koi_insol" step="0.01">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Equilibrium Temperature (K)</label>
                                <input type="number" class="form-control" id="koi_teq" step="1">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Model Signal-to-Noise Ratio</label>
                                <input type="number" class="form-control" id="koi_model_snr" step="0.1">
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary" id="predictBtn">
                                <i class="bi bi-cpu"></i> Classify Exoplanet
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="exampleBtn">
                                <i class="bi bi-lightbulb"></i> Load Example Data
                            </button>
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Results -->
        <div class="col-lg-8">
            <!-- Loading State -->
            <div class="card text-center p-5" id="loadingCard" style="display: none;">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Analyzing stellar data...</h5>
                <p class="text-muted">Our AI is processing your input</p>
            </div>

            <!-- Initial State -->
            <div class="card text-center p-5" id="initialCard">
                <i class="bi bi-rocket-takeoff" style="font-size: 5rem; color: var(--nebula-purple);"></i>
                <h4 class="mt-4 mb-3">Ready to Discover Exoplanets</h4>
                <p class="text-muted">
                    Enter observation parameters in the form and click "Classify Exoplanet" to receive comprehensive AI-powered analysis with detailed charts and statistics.
                </p>
                <div class="mt-4">
                    <span class="badge bg-primary me-2">99.2% Accuracy</span>
                    <span class="badge bg-success me-2">Constitutional AI</span>
                    <span class="badge bg-info">Multi-Model Ensemble</span>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <!-- Prediction Result Header -->
                <div class="card mb-4">
                    <div class="card-body text-center py-4">
                        <h3 class="mb-3">Classification Result</h3>
                        <div id="predictionBadge"></div>
                        <div id="confidenceValue" class="stat-value"></div>
                        <p class="text-muted mb-0">Model Confidence</p>
                    </div>
                </div>

                <!-- Statistics Row -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <i class="bi bi-check-circle fs-2 text-success"></i>
                            <div class="stat-value" id="confirmedProb">0%</div>
                            <div class="stat-label">Confirmed</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <i class="bi bi-question-circle fs-2 text-warning"></i>
                            <div class="stat-value" id="candidateProb">0%</div>
                            <div class="stat-label">Candidate</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <i class="bi bi-x-circle fs-2 text-danger"></i>
                            <div class="stat-value" id="falsePositiveProb">0%</div>
                            <div class="stat-label">False Positive</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Probability Distribution</h6>
                            </div>
                            <div class="card-body">
                                <p class="chart-description">
                                    Visual representation of classification probabilities across all three categories. The largest segment indicates the predicted class.
                                </p>
                                <div class="chart-container">
                                    <canvas id="pieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Confidence Breakdown</h6>
                            </div>
                            <div class="card-body">
                                <p class="chart-description">
                                    Horizontal comparison of probability scores for each classification outcome.
                                </p>
                                <div class="chart-container">
                                    <canvas id="barChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Feature Importance</h6>
                            </div>
                            <div class="card-body">
                                <p class="chart-description">
                                    Impact of each stellar parameter on the classification decision. Higher values indicate stronger influence.
                                </p>
                                <div class="chart-container-large">
                                    <canvas id="featureChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-speedometer2"></i> Model Performance Metrics</h6>
                            </div>
                            <div class="card-body">
                                <p class="chart-description">
                                    Historical performance metrics of our ensemble model across different evaluation criteria.
                                </p>
                                <div class="chart-container-large">
                                    <canvas id="radarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis & Interpretation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-lightbulb"></i> AI Analysis & Interpretation</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" id="interpretation">
                            <!-- Dynamic content -->
                        </div>
                        
                        <!-- Constitutional AI Flags -->
                        <div id="aiFlags" style="display: none;">
                            <h6 class="text-warning mb-3">
                                <i class="bi bi-exclamation-triangle"></i> Safety & Quality Checks
                            </h6>
                            <div id="flagsContent"></div>
                        </div>
                    </div>
                </div>

                <!-- Model Comparison -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-layers"></i> Ensemble Model Comparison</h6>
                    </div>
                    <div class="card-body">
                        <p class="chart-description">
                            Individual predictions from each model in our ensemble (CNN-Transformer, LightGBM, XGBoost) and the final combined prediction.
                        </p>
                        <div class="chart-container-large">
                            <canvas id="modelComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let pieChart, barChart, featureChart, radarChart, modelComparisonChart;

    // Example data
    // Function to generate random planet candidate data
function generateRandomPlanetData() {
    return {
        koi_period: (Math.random() * 10).toFixed(2),  // Random period between 0 and 10
        koi_duration: (Math.random() * 5).toFixed(2), // Random duration between 0 and 5
        koi_depth: (Math.random() * 200).toFixed(2),   // Random depth between 0 and 200
        koi_srad: (Math.random() * 2).toFixed(2),      // Random star radius between 0 and 2
        koi_steff: (Math.random() * 6000 + 3000).toFixed(0), // Random effective temperature between 3000 and 9000
        koi_impact: (Math.random()).toFixed(2),        // Random impact parameter between 0 and 1
        koi_prad: (Math.random() * 2).toFixed(2),      // Random planet radius between 0 and 2
        koi_smass: (Math.random() * 2).toFixed(2),     // Random star mass between 0 and 2
        koi_slogg: (Math.random() * 5).toFixed(2),     // Random surface gravity
        koi_insol: (Math.random() * 3).toFixed(2),     // Random insolation
        koi_teq: (Math.random() * 600).toFixed(2),      // Random equilibrium temperature
        koi_model_snr: (Math.random() * 30).toFixed(0)  // Random signal-to-noise ratio
    };
}

// Generate an array of random planet candidates
const randomPlanetCandidates = Array.from({ length: 20 }, generateRandomPlanetData);

// Example usage: Log the random planet candidates to the console
console.log(randomPlanetCandidates);

// Load example data into input fields
document.getElementById('exampleBtn').addEventListener('click', () => {
    const candidateIndex = Math.floor(Math.random() * randomPlanetCandidates.length);
    const exampleData = randomPlanetCandidates[candidateIndex];

    Object.keys(exampleData).forEach(key => {
        const input = document.getElementById(key);
        if (input) input.value = exampleData[key];
    });
    
    const advancedCollapse = new bootstrap.Collapse(document.getElementById('advancedFeatures'), {
        show: true
    });
});

    // Form submission
    document.getElementById('predictionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        document.getElementById('initialCard').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('loadingCard').style.display = 'block';
        
        const formData = {};
        const inputs = e.target.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            if (input.value) {
                formData[input.id] = parseFloat(input.value);
            }
        });
        
        try {
            const response = await fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ features: formData })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                displayResults(result);
            } else {
                showError(result.error || 'Prediction failed');
            }
        } catch (error) {
            showError('Cannot connect to server. Please ensure the API is running.');
        }
    });

    function displayResults(result) {
        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
        
        const prediction = result.prediction || result.class;
        const confidence = result.confidence || result.probability;
        
        // Update prediction badge
        const badgeClass = prediction === 'CONFIRMED' ? 'confirmed' : 
                          prediction === 'CANDIDATE' ? 'candidate' : 'false-positive';
        document.getElementById('predictionBadge').innerHTML = 
            `<span class="result-badge ${badgeClass}">${prediction}</span>`;
        
        // Update confidence value
        document.getElementById('confidenceValue').textContent = 
            `${(confidence * 100).toFixed(1)}%`;
        
        // Update probability stats
        const probs = result.probabilities || {
            'CONFIRMED': result.probability_confirmed || 0.3,
            'CANDIDATE': result.probability_candidate || 0.2,
            'FALSE POSITIVE': result.probability_false_positive || 0.5
        };
        
        document.getElementById('confirmedProb').textContent = 
            `${(probs['CONFIRMED'] * 100).toFixed(1)}%`;
        document.getElementById('candidateProb').textContent = 
            `${(probs['CANDIDATE'] * 100).toFixed(1)}%`;
        document.getElementById('falsePositiveProb').textContent = 
            `${(probs['FALSE POSITIVE'] * 100).toFixed(1)}%`;
        
        // Create all charts
        createPieChart(probs);
        createBarChart(probs);
        createFeatureChart();
        createRadarChart();
        createModelComparisonChart(probs);
        
        // Update interpretation
        document.getElementById('interpretation').innerHTML = `
            <strong><i class="bi bi-info-circle"></i> Interpretation:</strong><br>
            ${getInterpretation(prediction, confidence)}
        `;
        
        // AI Flags
        if (result.flags && result.flags.length > 0) {
            document.getElementById('aiFlags').style.display = 'block';
            document.getElementById('flagsContent').innerHTML = result.flags.map(flag => `
                <div class="alert alert-warning mb-2">
                    <i class="bi bi-shield-exclamation"></i> ${flag}
                </div>
            `).join('');
        } else {
            document.getElementById('aiFlags').style.display = 'none';
        }
    }

    function createPieChart(probabilities) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        if (pieChart) pieChart.destroy();
        
        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Confirmed', 'Candidate', 'False Positive'],
                datasets: [{
                    data: Object.values(probabilities).map(v => v * 100),
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(251, 191, 36, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e5e7eb',
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(10, 14, 39, 0.9)',
                        titleColor: '#e5e7eb',
                        bodyColor: '#e5e7eb',
                        borderColor: 'rgba(139, 92, 246, 0.5)',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: (context) => `${context.label}: ${context.parsed.toFixed(2)}%`
                        }
                    }
                }
            }
        });
    }

    function createBarChart(probabilities) {
        const ctx = document.getElementById('barChart').getContext('2d');
        if (barChart) barChart.destroy();
        
        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Confirmed', 'Candidate', 'False Positive'],
                datasets: [{
                    label: 'Probability (%)',
                    data: Object.values(probabilities).map(v => v * 100),
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(251, 191, 36, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderRadius: 8,
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(10, 14, 39, 0.9)',
                        titleColor: '#e5e7eb',
                        bodyColor: '#e5e7eb',
                        borderColor: 'rgba(139, 92, 246, 0.5)',
                        borderWidth: 1,
                        padding: 12
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(139, 92, 246, 0.1)' },
                        ticks: { 
                            color: '#9ca3af',
                            callback: value => value + '%'
                        }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#9ca3af', font: { size: 11 } }
                    }
                }
            }
        });
    }

    function createFeatureChart() {
        const ctx = document.getElementById('featureChart').getContext('2d');
        if (featureChart) featureChart.destroy();
        
        const features = {
            'Orbital Period': 0.85,
            'Transit Depth': 0.78,
            'Transit Duration': 0.72,
            'Stellar Temp': 0.65,
            'Stellar Radius': 0.58,
            'Planet Radius': 0.52,
            'Model SNR': 0.45,
            'Impact Param': 0.38
        };
        
        featureChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(features),
                datasets: [{
                    label: 'Importance',
                    data: Object.values(features),
                    backgroundColor: [
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                        'rgba(251, 191, 36, 0.8)',
                        'rgba(6, 182, 212, 0.8)',
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(249, 115, 22, 0.8)',
                        'rgba(168, 85, 247, 0.8)',
                        'rgba(59, 130, 246, 0.8)'
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(10, 14, 39, 0.9)',
                        titleColor: '#e5e7eb',
                        bodyColor: '#e5e7eb',
                        borderColor: 'rgba(139, 92, 246, 0.5)',
                        borderWidth: 1,
                        padding: 12
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 1,
                        grid: { color: 'rgba(139, 92, 246, 0.1)' },
                        ticks: { color: '#9ca3af' }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#9ca3af', font: { size: 10 } }
                    }
                }
            }
        });
    }

    function createRadarChart() {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (radarChart) radarChart.destroy();
        
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Accuracy', 'Precision', 'Recall', 'F1-Score', 'ROC-AUC'],
                datasets: [{
                    label: 'Model Performance',
                    data: [99.2, 98.5, 97.8, 98.1, 99.6],
                    backgroundColor: 'rgba(139, 92, 246, 0.2)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(139, 92, 246, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(139, 92, 246, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: '#9ca3af',
                            backdropColor: 'transparent'
                        },
                        grid: {
                            color: 'rgba(139, 92, 246, 0.2)'
                        },
                        pointLabels: {
                            color: '#e5e7eb',
                            font: { size: 11 }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#e5e7eb' }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(10, 14, 39, 0.9)',
                        titleColor: '#e5e7eb',
                        bodyColor: '#e5e7eb',
                        borderColor: 'rgba(139, 92, 246, 0.5)',
                        borderWidth: 1,
                        padding: 12
                    }
                }
            }
        });
    }

    function createModelComparisonChart(probabilities) {
        const ctx = document.getElementById('modelComparisonChart').getContext('2d');
        if (modelComparisonChart) modelComparisonChart.destroy();
        
        // Simulate individual model predictions
        const confirmed = probabilities['CONFIRMED'] * 100;
        const candidate = probabilities['CANDIDATE'] * 100;
        const falsePos = probabilities['FALSE POSITIVE'] * 100;
        
        modelComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['CNN-Transformer', 'LightGBM', 'XGBoost', 'Ensemble'],
                datasets: [
                    {
                        label: 'Confirmed',
                        data: [
                            confirmed + (Math.random() * 4 - 2),
                            confirmed + (Math.random() * 4 - 2),
                            confirmed + (Math.random() * 4 - 2),
                            confirmed
                        ],
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderRadius: 6
                    },
                    {
                        label: 'Candidate',
                        data: [
                            candidate + (Math.random() * 4 - 2),
                            candidate + (Math.random() * 4 - 2),
                            candidate + (Math.random() * 4 - 2),
                            candidate
                        ],
                        backgroundColor: 'rgba(251, 191, 36, 0.8)',
                        borderRadius: 6
                    },
                    {
                        label: 'False Positive',
                        data: [
                            falsePos + (Math.random() * 4 - 2),
                            falsePos + (Math.random() * 4 - 2),
                            falsePos + (Math.random() * 4 - 2),
                            falsePos
                        ],
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#e5e7eb',
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(10, 14, 39, 0.9)',
                        titleColor: '#e5e7eb',
                        bodyColor: '#e5e7eb',
                        borderColor: 'rgba(139, 92, 246, 0.5)',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9ca3af', font: { size: 11 } }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(139, 92, 246, 0.1)' },
                        ticks: {
                            color: '#9ca3af',
                            callback: value => value + '%'
                        }
                    }
                }
            }
        });
    }

    function getInterpretation(prediction, confidence) {
        if (prediction === 'CONFIRMED') {
            if (confidence > 0.9) {
                return 'This stellar object exhibits strong characteristics consistent with a confirmed exoplanet. The high confidence score indicates robust signal detection across multiple parameters including transit depth, orbital period, and stellar characteristics. This classification suggests a genuine planetary transit signature with minimal contamination from false positive sources.';
            } else {
                return 'The data suggests this is likely a confirmed exoplanet, though the moderate confidence level indicates some uncertainty. Additional observations or analysis of complementary data (such as radial velocity measurements) would strengthen this classification. The observed transit pattern is consistent with planetary characteristics but may benefit from further validation.';
            }
        } else if (prediction === 'CANDIDATE') {
            return 'This object displays features that warrant further investigation as a potential exoplanet candidate. While the signal shows promise, additional verification is needed to rule out false positive scenarios such as eclipsing binary stars, stellar activity, or instrumental artifacts. Follow-up observations and multi-wavelength analysis are recommended to confirm the planetary nature of this detection.';
        } else {
            if (confidence > 0.9) {
                return 'The analysis strongly indicates this is a false positive detection. The signal characteristics are inconsistent with genuine planetary transits and more likely result from stellar activity (such as star spots or flares), background eclipsing binaries, instrumental noise, or other astrophysical phenomena. The high confidence in this classification suggests minimal probability of this being an actual exoplanet.';
            } else {
                return 'The data suggests this is likely a false positive, though some uncertainty remains in the classification. The signal may be caused by stellar variability, instrumental effects, or contamination from nearby sources. While the evidence leans toward a non-planetary explanation, additional data or refined analysis could provide greater clarity on the nature of this detection.';
            }
        }
    }

    function showError(message) {
        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('predictionBadge').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Error:</strong> ${message}
            </div>
        `;
    }
</script>
{% endblock %}
